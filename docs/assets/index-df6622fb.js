(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const e of i)if(e.type==="childList")for(const n of e.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function a(i){const e={};return i.integrity&&(e.integrity=i.integrity),i.referrerPolicy&&(e.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?e.credentials="include":i.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function s(i){if(i.ep)return;i.ep=!0;const e=a(i);fetch(i.href,e)}})();const E=[..."!),.:;?]]¢—’”‰℃℉、。々〉》」』】〕〟ぁぃぅぇぉっゃゅょゎ゛゜ゝゞァィゥェォッャュョヮヵヶ・ーヽヾ！％），．：；？］｝"],z=[..."([{£§‘“〈《「『【〒〔〝＃＄（＠［｛￥"],B=[...E,...z],L=[..."0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"],_=(t,o,a)=>{const s=[o[a]];let i=1,e=o[a].metrix.width;if(L.includes(t[a])){for(let n=a+1;n<t.length&&L.includes(t[n]);n++)i++,e+=o[n].metrix.width,s.push(o[n]);return{length:i,width:e,chars:s}}if(B.includes(t[a])){for(let n=a+1;n<t.length&&B.includes(t[n]);n++)i++,e+=o[n].metrix.width,s.push(o[n]);return{length:i,width:e,chars:s}}return{length:i,width:e,chars:s}},F=(t,o,a)=>{const s=_(t,o,a);let i=a+s.length;for(;i<o.length;){const e=o[i];if(E.includes(t[i]))s.length++,s.width+=e.metrix.width,s.chars.push(e),i++;else break}return s},I=(t,o,a)=>{const s=[],i=()=>{const r={at:0,width:0,lineAscent:0,lineDescent:0,lineMargin:0};return s.push(r),r};let e=i(),n=0;for(;n<o.length;){if(t[n]===`
`){e.lineAscent=Math.max(e.lineAscent,o[n].metrix.fontBoundingBoxAscent),e.lineDescent=Math.max(e.lineDescent,o[n].metrix.fontBoundingBoxDescent),n++,e=i(),e.at=n;continue}const c=F(t,o,n);e.width+c.width>a&&(e=i(),e.at=n),e.width+=c.width,e.lineAscent=Math.max(e.lineAscent,...c.chars.map(f=>f.metrix.fontBoundingBoxAscent)),e.lineDescent=Math.max(e.lineDescent,...c.chars.map(f=>f.metrix.fontBoundingBoxDescent)),n+=c.length}return s};let v=!1;const U=t=>{v=t},p=document.createElement("canvas");p.width=1;p.height=1;p.style.writingMode="vertical-rl";const D=p.getContext("2d"),W=(t,o)=>{t.font=`${o.fontStyle} ${o.fontWeight} ${o.fontSize}px ${o.fontFamily}`,t.fillStyle=o.fontColor},R=t=>{const{initialStyle:o,styles:a}=t,s=[],i=[];a.forEach(n=>i[n.at]=n),W(D,o);let e={...o};for(let n=0;n<t.text.length;n++){const r=t.text[n],c=i[n];c&&(e={...e,...c.style},W(D,e)),s.push({metrix:D.measureText(r)})}return s},k=(t,o)=>(t.lineAscent+t.lineDescent)*(o-1)/2,P=(t,o,a,s,i)=>{const{initialStyle:e,styles:n,text:r,lineHeight:c=1}=o,f=[];n.forEach(d=>f[d.at]=d);const g=[];if(s.forEach(d=>g[d.at]=d),r.length!==a.length)throw new Error("text length and charWidths length are not equal");const b=()=>{switch(o.align){case"center":return(i-h.width)/2;case"right":return i-h.width;default:return 0}};let h=g[0],A={...e};W(t,A);let m=b(),u=(h.lineAscent+h.lineDescent)*(c-1)/2;for(let d=0;d<r.length;d++){const O=r[d],y=a[d],H=f[d];if(g[d]){if(d!==0){if(u+=h.lineAscent+h.lineDescent,u+=k(h,c),v){t.save(),t.beginPath(),t.strokeStyle="blue",t.setLineDash([2,2]);const T=b();t.moveTo(T,u),t.lineTo(T+h.width,u),t.stroke(),t.restore()}h=g[d],m=b(),u+=k(h,c)}v&&(t.save(),t.beginPath(),t.strokeStyle="blue",t.strokeRect(m,u,h.width,h.lineAscent+h.lineDescent),t.setLineDash([5,5]),t.moveTo(m,u+h.lineAscent),t.lineTo(m+h.width,u+h.lineAscent),t.stroke(),t.restore())}H&&(A={...A,...H.style},W(t,A)),t.fillText(O,m,u+h.lineAscent),v&&(t.save(),t.strokeStyle="red",t.strokeRect(m,u+h.lineAscent-y.metrix.actualBoundingBoxAscent,y.metrix.width,y.metrix.actualBoundingBoxAscent+y.metrix.actualBoundingBoxDescent),t.restore()),m+=y.metrix.width}},N=(t,o,a,s,i,e)=>{p.style.writingMode=o.direction==="vertical"?"vertical-rl":"horizontal-tb";const n=e!=null&&e.charWidths?e==null?void 0:e.charWidths:R(o),r=e!=null&&e.charWidths&&(e!=null&&e.lineBreaks)?e==null?void 0:e.lineBreaks:I(o.text,n,i),c=r.reduce((f,g)=>f+(g.lineAscent+g.lineDescent)*(o.lineHeight??1),0);return t.save(),o.direction==="vertical"?(t.rotate(Math.PI/2*1),t.translate(s,-a)):t.translate(a,s),v&&(t.save(),t.strokeStyle="green",t.strokeRect(-1,-1,i+2,c+2),t.restore()),P(t,o,n,r,i),t.restore(),{charWidths:n,lineBreaks:r}},C=400,V=700,S={text:`Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt _~^,|... 

  花子は、古びたアトリエで縦書きCanvasに思いを馳せていた。彼女の心は、過去の情熱的な絵画と未来の可能性とで彩られていた。CanvasRenderingContext2Dを通じて、彼女の筆が魔法のように踊り、色と形が交じり合う。「その魔法のキャンバスには、季節が舞い、想像が咲く」。花子の作品は、縦書きならではの風情が溢れ、心の底からの芸術の詩となるのだった。`,initialStyle:{fontFamily:"sans-serif",fontSize:20,fontColor:"#333",fontWeight:C,fontStyle:"normal"},styles:[{at:5,style:{fontFamily:'"Times"',fontWeight:V,fontSize:36,fontColor:"#39a"}},{at:12,style:{fontFamily:'"Hiragino Maru Gothic Pro"',fontSize:18,fontColor:"#777"}},{at:22,style:{fontWeight:V,fontSize:32,fontColor:"#ea3"}},{at:27,style:{fontWeight:C,fontColor:"#777"}},{at:58,style:{fontColor:"#f63",fontSize:40}},{at:61,style:{fontColor:"#777",fontSize:18}},{at:103,style:{fontFamily:"'Zen Kurenaido'",fontColor:"#777",fontSize:18}}],lineHeight:1.5,align:"left",direction:"horizontal"};const w=t=>document.querySelector(t),$=w("#app"),l={wrapWidth:500,debug:!1,isVertical:S.direction==="vertical",lineHeight:S.lineHeight,align:S.align,onUpdate:()=>{}},G=()=>{const t=w("#wrapWidth");t.value=l.wrapWidth.toString();const o=w("#wrapWidthValue");t.addEventListener("input",()=>{o.innerText=t.value+"px",l.wrapWidth=t.valueAsNumber,l.onUpdate()});const a=w("#debug");a.checked=l.debug,a.addEventListener("change",r=>{l.debug=r.target.checked,l.onUpdate()});const s=w("#vertical");s.checked=l.isVertical,s.addEventListener("change",r=>{l.isVertical=r.target.checked,l.onUpdate()});const i=w("#lineHeight");i.value=l.lineHeight.toString();const e=w("#lineHeightValue");i.addEventListener("input",()=>{e.innerText=i.value,l.lineHeight=i.valueAsNumber,l.onUpdate()});const n=w("#textAlign");n.value=l.align,n.addEventListener("change",r=>{const c=r.target.value,f=["left","center","right"].find(g=>g===c);f&&(l.align=f,l.onUpdate())})},q=()=>{const t=document.createElement("canvas"),o=t.getContext("2d");t.style.border="1px solid black",$.appendChild(t);const a={wrapWidth:l.wrapWidth,isVertical:l.isVertical};let s;const i=()=>{U(l.debug);const e={...S};e.align=l.align,e.lineHeight=l.lineHeight,e.direction=l.isVertical?"vertical":"horizontal";const n=e.direction==="vertical";t.style.writingMode=n?"vertical-rl":"horizontal-tb";const r=t.width/2,c=t.height/2,f=n?r:0,g=n?c:r;console.time("drawText"),s=N(o,e,f,0,g,s),console.timeEnd("drawText")};l.onUpdate=()=>{const e=l.isVertical,n=800,r=e?n:l.wrapWidth,c=e?l.wrapWidth:n;t.width=r*2,t.height=c*2,t.style.width=`${r}px`,t.style.height=`${c}px`,o.resetTransform(),o.scale(2,2),a.isVertical!==l.isVertical&&(s=void 0),a.wrapWidth!==l.wrapWidth&&s&&(s.lineBreaks=void 0),a.wrapWidth=l.wrapWidth,a.isVertical=l.isVertical,i()},G(),l.onUpdate()},x=async()=>{await document.fonts.ready,window.requestAnimationFrame(l.onUpdate)};q();x();
